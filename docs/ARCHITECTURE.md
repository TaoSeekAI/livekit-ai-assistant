# 系统架构设计文档

## 1. 总体架构

### 1.1 架构图

```
┌──────────────────────────────────────────────────────────────────────┐
│                          客户端层 (Client Layer)                      │
│                                                                        │
│  ┌────────────────────────────────────────────────────────────┐      │
│  │                    Android Application                      │      │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │      │
│  │  │   UI     │  │ LiveKit  │  │  Camera  │  │  Audio   │   │      │
│  │  │ Layer    │  │ Manager  │  │ Manager  │  │ Manager  │   │      │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │      │
│  │       └──────────────┼─────────────┴─────────────┘         │      │
│  │                      │                                      │      │
│  │              ┌───────▼────────┐                            │      │
│  │              │ LiveKit Client │                            │      │
│  │              │      SDK       │                            │      │
│  │              └───────┬────────┘                            │      │
│  └──────────────────────┼─────────────────────────────────────┘      │
└────────────────────────┼──────────────────────────────────────────────┘
                         │
                         │ WebRTC (SRTP/SCTP)
                         │
┌────────────────────────▼──────────────────────────────────────────────┐
│                      传输层 (Transport Layer)                          │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────┐        │
│  │                  LiveKit Server (SFU)                     │        │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │        │
│  │  │  Signal  │  │   Room   │  │  Media   │  │   Data   │ │        │
│  │  │  Server  │  │ Manager  │  │ Router   │  │ Channel  │ │        │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │        │
│  │       └──────────────┼─────────────┴─────────────┘       │        │
│  │                      │                                    │        │
│  │              ┌───────▼────────┐                          │        │
│  │              │   Track Store  │                          │        │
│  │              │   & Publisher  │                          │        │
│  │              └───────┬────────┘                          │        │
│  └──────────────────────┼───────────────────────────────────┘        │
└────────────────────────┼──────────────────────────────────────────────┘
                         │
                         │ Agent Worker Protocol (WebSocket)
                         │
┌────────────────────────▼──────────────────────────────────────────────┐
│                       处理层 (Processing Layer)                        │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────┐        │
│  │               Python AI Agent Worker                      │        │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │        │
│  │  │  Voice   │  │  Vision  │  │   LLM    │  │Response  │ │        │
│  │  │Pipeline  │  │Processor │  │Processor │  │Generator │ │        │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │        │
│  │       │             │              │             │        │        │
│  │       ▼             ▼              ▼             ▼        │        │
│  │  ┌──────────────────────────────────────────────────┐   │        │
│  │  │              Agent Core Engine                    │   │        │
│  │  └──────────────────┬───────────────────────────────┘   │        │
│  └─────────────────────┼───────────────────────────────────┘        │
└────────────────────────┼──────────────────────────────────────────────┘
                         │
                         │ API Calls
                         │
┌────────────────────────▼──────────────────────────────────────────────┐
│                        AI服务层 (AI Services)                          │
│                                                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │  OpenAI  │  │DeepGram  │  │ElevenLabs│  │  YOLOv8  │             │
│  │Whisper   │  │   STT    │  │   TTS    │  │ Detection│             │
│  │   STT    │  │          │  │          │  │          │             │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘             │
│                                                                        │
│  ┌──────────┐  ┌──────────┐                                          │
│  │  GPT-4   │  │  Claude  │                                          │
│  │   LLM    │  │   LLM    │                                          │
│  └──────────┘  └──────────┘                                          │
└────────────────────────────────────────────────────────────────────────┘
```

## 2. 核心组件

### 2.1 Android客户端

#### 2.1.1 LiveKitManager
**职责**: 管理与LiveKit服务器的连接和房间操作

**关键功能**:
- 建立WebRTC连接
- 加入/离开房间
- 管理音视频轨道
- 处理连接状态

**主要方法**:
```kotlin
class LiveKitManager {
    suspend fun connect(url: String, token: String)
    suspend fun disconnect()
    fun publishCamera()
    fun publishMicrophone()
    fun sendData(data: ByteArray)
}
```

#### 2.1.2 CameraManager
**职责**: 管理摄像头和图片拍摄

**关键功能**:
- 初始化CameraX
- 拍照
- 图片编码
- 预览管理

#### 2.1.3 AudioManager
**职责**: 音频录制和播放管理

**关键功能**:
- 麦克风权限管理
- 音频路由控制
- 音量控制

### 2.2 LiveKit Server

#### 2.2.1 信令服务器 (Signal Server)
**职责**: 处理客户端连接和房间协商

**功能**:
- WebSocket连接管理
- SDP交换
- ICE候选交换
- 房间状态同步

#### 2.2.2 媒体路由器 (Media Router)
**职责**: 转发音视频流

**特性**:
- Selective Forwarding Unit (SFU)
- 自适应比特率
- 模拟cast
- 带宽估计

### 2.3 Python AI Agent

#### 2.3.1 VoicePipelineAgent
**职责**: 处理语音交互流程

**流程**:
```
Audio Input → VAD → STT → LLM → TTS → Audio Output
```

**组件**:
- VAD (Voice Activity Detection): 检测语音活动
- STT (Speech-to-Text): 语音转文字
- LLM (Large Language Model): 对话处理
- TTS (Text-to-Speech): 文字转语音

#### 2.3.2 VisionProcessor
**职责**: 视频帧分析和物体检测

**功能**:
- 视频帧采样
- 物体检测 (YOLOv8)
- 场景理解
- 结果描述生成

**处理流程**:
```
Video Frame → Decode → Inference → Post-process → Description
```

## 3. 数据流

### 3.1 语音对话流程

```
┌─────────┐    1.语音    ┌──────────┐    2.音频流    ┌─────────┐
│ Android │─────────────>│ LiveKit  │──────────────>│ Agent   │
│ Client  │              │  Server  │               │ Worker  │
└─────────┘              └──────────┘               └─────────┘
     ▲                                                    │
     │                                                    │ 3.STT
     │                                                    ▼
     │                                              ┌─────────┐
     │                                              │ Whisper │
     │                                              └─────────┘
     │                                                    │
     │                                                    │ 4.文本
     │                                                    ▼
     │                                              ┌─────────┐
     │                      5.响应文本              │  GPT-4  │
     │                  <────────────────────────── └─────────┘
     │                                                    │
     │                                                    │ 6.TTS
     │                                                    ▼
     │                                              ┌─────────┐
     │              8.语音回复                      │ OpenAI  │
     │  <──────────────────────────────────────── │   TTS   │
                                                   └─────────┘
```

### 3.2 视频识别流程

```
┌─────────┐   1.视频流   ┌──────────┐   2.视频轨道   ┌─────────┐
│ Android │────────────>│ LiveKit  │──────────────>│ Agent   │
│ Client  │             │  Server  │               │ Worker  │
└─────────┘             └──────────┘               └─────────┘
     ▲                                                   │
     │                                                   │ 3.帧提取
     │                                                   ▼
     │                                             ┌──────────┐
     │                                             │  Vision  │
     │                                             │Processor │
     │                                             └──────────┘
     │                                                   │
     │                                                   │ 4.检测
     │                                                   ▼
     │                                             ┌──────────┐
     │                                             │ YOLOv8   │
     │                                             │  Model   │
     │                                             └──────────┘
     │                                                   │
     │                                                   │ 5.结果
     │                                                   ▼
     │                  6.描述生成                 ┌──────────┐
     │              <──────────────────────────── │Description│
     │                                             │ Generator │
     │                                             └──────────┘
     │                                                   │
     │                                                   │ 7.语音合成
     │                  8.语音回复                       ▼
     │  <──────────────────────────────────────────── [TTS]
```

### 3.3 图片上传流程

```
┌─────────┐   1.选择图片  ┌─────────┐   2.编码     ┌─────────┐
│  用户   │──────────────>│ Camera  │─────────────>│  Image  │
│         │               │ Manager │              │ Encoder │
└─────────┘               └─────────┘              └─────────┘
                                                         │
                                                         │ 3.字节数据
                                                         ▼
┌─────────┐   5.识别结果  ┌──────────┐  4.数据消息  ┌─────────┐
│ Android │<──────────── │ LiveKit  │<────────────│ LiveKit │
│  UI     │              │  Server  │             │ Manager │
└─────────┘              └──────────┘             └─────────┘
     ▲                         │
     │                         │ 6.转发
     │                         ▼
     │                   ┌──────────┐
     │                   │  Agent   │
     │                   │  Worker  │
     │                   └──────────┘
     │                         │
     │                         │ 7.处理
     │                         ▼
     │                   ┌──────────┐
     │    8.结果回传     │  Vision  │
     └───────────────── │Processor │
                        └──────────┘
```

## 4. 安全架构

### 4.1 认证流程

```
┌─────────┐              ┌──────────┐              ┌─────────┐
│ Android │   1.请求Token │   App    │  2.生成Token │ LiveKit │
│ Client  │─────────────>│  Server  │─────────────>│  Server │
└─────────┘              └──────────┘              └─────────┘
     │                         │                         │
     │    3.返回Token          │                         │
     │<────────────────────────┘                         │
     │                                                    │
     │    4.使用Token连接                                │
     │───────────────────────────────────────────────────>│
     │                                                    │
     │    5.验证Token                                    │
     │<───────────────────────────────────────────────────┘
     │                                                    │
     │    6.建立WebRTC连接                               │
     │<──────────────────────────────────────────────────>│
```

### 4.2 数据加密

- **传输加密**: DTLS-SRTP (WebRTC标准)
- **信令加密**: WSS (WebSocket Secure)
- **API调用**: HTTPS

## 5. 性能优化

### 5.1 网络优化
- 自适应比特率控制
- 网络质量检测
- 重传机制 (NACK/FEC)

### 5.2 计算优化
- 视频帧采样率控制 (默认1FPS)
- 模型量化 (YOLOv8n轻量模型)
- 异步处理避免阻塞

### 5.3 内存优化
- 帧缓冲池
- 及时释放资源
- 内存泄漏检测

## 6. 可扩展性

### 6.1 水平扩展
- LiveKit Server集群
- Agent Worker负载均衡
- Redis会话共享

### 6.2 功能扩展
- 插件化AI模型
- 自定义识别规则
- 多语言支持

## 7. 监控和日志

### 7.1 日志级别
- DEBUG: 详细调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息

### 7.2 监控指标
- 连接数
- 媒体质量 (丢包率、延迟)
- AI处理时延
- 错误率

## 8. 部署架构

### 8.1 开发环境
```
Docker Compose
├── livekit-server
├── agent-worker
└── (Android模拟器/真机)
```

### 8.2 生产环境
```
Kubernetes Cluster
├── LiveKit Server (StatefulSet)
├── Agent Workers (Deployment, Auto-scaling)
├── Redis (StatefulSet)
└── Monitoring Stack (Prometheus + Grafana)
```

## 9. 技术债务和改进方向

### 9.1 当前限制
- Agent无状态，不支持跨会话记忆
- 视频识别精度受光线影响
- 实时性依赖网络质量

### 9.2 改进计划
- 添加会话持久化
- 集成更多视觉模型
- 端到端加密增强
- 离线模式支持
